{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | LinkedIn</title>
    <link rel="icon" type="image/png" href="{% static 'images/linkedin-icon.png' %}">
    <link rel="stylesheet" href="{% static 'css/home_page/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile_page/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <!-- ensure CSRF cookie is present for AJAX calls -->
    <form style="display:none;">
        {% csrf_token %}
    </form>
    <!-- reuse header from home_page -->
    <header>
        <div class="header-inner site-wrapper">
            <div class="logo">
                <a href="{% url 'home' %}" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-supported-dps="24x24"
                        fill="#0a66c2" class="mercado-match" width="45" height="45" focusable="false">
                        <path
                            d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z">
                        </path>
                    </svg>
                </a>
                <input class="input" type="text" placeholder="&#128269; Search" />
            </div>
            <div class="icons-btn-div">
                <div class="icons">
                    <a class="icon" href="{% url 'home' %}" style="text-decoration:none;">
                        <i class="fa-solid fa-house"></i>
                        <p class="nav-text">Home</p>
                    </a>
                    <a class="icon" href="{% url 'connections' %}" style="text-decoration:none;">
                        <i class="fa-solid fa-users"></i>
                        <p>My Network</p>
                    </a>
                    <div class="icon">
                        <i class="fa-solid fa-briefcase"></i>
                        <p>Job</p>
                    </div>
                    <div class="icon">
                        <i class="fa-solid fa-comment-dots"></i>
                        <p>Messaging</p>
                    </div>
                    <div class="icon notif">
                        <a href="{% url 'connections' %}"
                            style="position:relative; text-decoration:none; color:inherit;">
                            <i class="fa-solid fa-bell"></i>
                            {% if unread_notif_count and unread_notif_count > 0 %}
                            <span class="notif-count">{{ unread_notif_count }}</span>
                            {% endif %}
                        </a>
                        <div class="notif-dropdown">
                            <ul>
                                {% for n in recent_notifications %}
                                <li>
                                    <a href="{% url 'mark_notification' n.id %}"
                                        style="text-decoration:none;color:inherit;display:block;">
                                        <strong>{{ n.from_user.username }}</strong>: {{ n.message }} <br />
                                        <small>{{ n.created_at|date:"M d, H:i" }}</small>
                                    </a>
                                </li>
                                {% empty %}
                                <li>No notifications</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <p>Notification</p>
                    </div>
                    <div class="icon">
                        <i class="fa-solid fa-user"></i>
                        <p><a href="{% url 'profile' %}" style="text-decoration:none;color:inherit;">Me</a></p>
                    </div>
                </div>
                <div class="partition"></div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div class="btns">
                        <a class="btn-link" href="{% url 'default' %}">Logout</a>
                    </div>
                </div>
            </div>
            <div class="icons-btn">

            </div>
    </header>

    <main class="container site-wrapper">
        <!-- Left Sidebar -->
        <aside>
            <div class="profile-card sidebar-left">
                <!-- Profile Image -->
                <div class="profile-avatar">
                    {% if user_profile.profile.profile_picture %}
                    <img src="{{ user_profile.profile.profile_picture.url }}" alt="Profile Pic">
                    {% else %}
                    <div class="default-avatar">
                        {{ user_profile.username|first|upper }}
                    </div>
                    {% endif %}
                </div>

                <!-- Username -->
                <h3>{{ user_profile.get_full_name|default:user_profile.username }}</h3>

                <!-- Connection count link -->
                <a href="{% url 'connections' %}" style="text-decoration:none;color:inherit;">
                    <p><strong>{{ connection_count }}</strong><br>Connections</p>
                </a>

                <!-- Latest Experience Company (if any) -->
                {% if experiences %}
                {% with experiences.0 as latest_exp %}
                <p><strong>Company:</strong> {{ latest_exp.company }}</p>
                {% endwith %}
                {% endif %}

            </div>
        </aside>

        <!-- Profile Posts -->
        <section class="feed">

            <!-- Profile header (LinkedIn-like) -->
            <div class="profile-header">
                {% if user_profile.profile.background_image %}
                <div class="profile-cover"
                    style="background-image: url('{{ user_profile.profile.background_image.url }}'); background-size: cover; background-position: center;">
                </div>
                {% else %}
                <div class="profile-cover"></div>
                {% endif %}
                <div class="profile-header-inner site-wrapper">
                    <div class="profile-left">
                        <div class="profile-avatar-large">
                            {% if user_profile.profile.profile_picture %}
                            <img src="{{ user_profile.profile.profile_picture.url }}" alt="Profile Pic">
                            {% else %}
                            <div class="default-avatar-large">{{ user_profile.username|first|upper }}</div>
                            {% endif %}
                        </div>
                        <div class="profile-meta">
                            <h1>{{ user_profile.get_full_name|default:user_profile.username }}</h1>
                            <p class="muted">{{ user_profile.profile.headline|default:'' }}</p>
                            {% if user_profile.profile.location %}
                            <p class="muted small">{{ user_profile.profile.location }}</p>
                            {% endif %}
                            <p><a class="connections-link" href="{% url 'connections' %}">{{ connection_count }}
                                    connections</a></p>
                            <div class="profile-actions">
                                <button class="btn primary">Open to</button>
                                <button class="btn outline">Add profile section</button>
                                <button class="btn outline">Enhance profile</button>
                                <button class="btn ghost">Resources</button>
                            </div>
                        </div>
                    </div>
                    <div class="profile-right">
                        <button id="editProfileBtn" class="btn outline">Edit</button>
                    </div>
                    <div class="profile-top-badges">
                        {% if user_profile.profile.company %}
                        <div class="badge">{{ user_profile.profile.company }}</div>
                        {% endif %}
                        {% if user_profile.profile.education %}
                        <div class="badge">{{ user_profile.profile.education }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            </div>

            <!-- Activity / Experience / Education cards -->
            <div class="cards-row">
                <div class="card activity-card">
                    <div class="card-header">
                        <h3>Activity</h3>
                        <button class="start-a-post">Create a post</button>
                        <div>
                            <button class="card-edit" data-target="#activityModal">Edit</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p>{{ user_profile.profile.bio|default:'You haven\'t posted yet' }}</p>
                    </div>
                    <hr class="show-all-posts-hr">
                    <a href="{% url 'user_posts' request.user.username %}">
                        <div class="show-all-posts">
                            <i>Show all posts</i>
                        </div>
                    </a>
                </div>

                <div class="card experience-card">
                    <div class="card-header">
                        <h3>Experience</h3>
                        <button class="card-edit" data-target="#experienceModal">Add</button>
                    </div>
                    <div class="card-body">
                        {% if experiences %}
                        <ul class="list-unstyled">
                            {% for exp in experiences %}
                            <li>
                                <div class="item-icon">🏢</div>
                                <div class="item-content">
                                    <strong>{{ exp.title }}</strong>
                                    <div class="muted">{{ exp.company }} &middot; {{ exp.location }}</div>
                                    <div class="muted">{{ exp.start_date }} - {% if exp.end_date %}{{ exp.end_date }}{%
                                        else %}Present{% endif %}</div>
                                </div>
                                <div class="actions-right">
                                    <button class="card-edit small" data-target="#experienceModal"
                                        data-id="{{ exp.id }}" data-title="{{ exp.title }}"
                                        data-company="{{ exp.company }}" data-start_date="{{ exp.start_date }}"
                                        data-end_date="{{ exp.end_date }}"
                                        data-location="{{ exp.location }}">✏️</button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p>No experience yet</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card education-card">
                    <div class="card-header">
                        <h3>Education</h3>
                        <button class="card-edit" data-target="#educationModal">Add</button>
                    </div>
                    <div class="card-body">
                        {% if user_profile.educations.all %}
                        <ul class="list-unstyled">
                            {% for edu in user_profile.educations.all %}
                            <li>
                                <div class="item-icon">🎓</div>
                                <div class="item-content">
                                    <strong>{{ edu.school }}</strong>
                                    <div class="muted">{{ edu.degree }}</div>
                                    <div class="muted">{{ edu.start_year }} - {% if edu.end_year %}{{ edu.end_year }}{%
                                        else %}Present{% endif %}</div>
                                </div>
                                <div class="actions-right">
                                    <button class="card-edit small" data-target="#educationModal" data-id="{{ edu.id }}"
                                        data-school="{{ edu.school }}" data-degree="{{ edu.degree }}"
                                        data-start_year="{{ edu.start_year }}"
                                        data-end_year="{{ edu.end_year }}">✏️</button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p>No education listed</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- create a post modal -->
            <div id="postModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Create a Post</h2>
                    <form method="POST" action="{% url 'home' %}">
                        {% csrf_token %}
                        <textarea name="content" placeholder="What do you want to talk about?" required></textarea>
                        <input type="file" name="image" accept="image/*">
                        <input type="file" name="video" accept="video/*">
                        <input type="url" name="url" class="url" placeholder="Reference URL (optional)">
                        <button type="submit">Post</button>
                    </form>
                </div>
            </div>

            <!-- Activity Modal -->
            <div id="activityModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close activityClose">&times;</span>
                    <h3>Edit activity</h3>
                    <form method="POST" action="{% url 'save_activity' %}">
                        {% csrf_token %}
                        <textarea name="bio" rows="4">{{ user_profile.profile.bio }}</textarea>
                        <div style="text-align:right;margin-top:10px;"><button type="submit"
                                class="btn primary">Save</button></div>
                    </form>
                </div>
            </div>

            <!-- Experience Modal -->
            <div id="experienceModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close experienceClose">&times;</span>
                    <h3>Add / Edit experience</h3>
                    <form method="POST" action="{% url 'save_experience' %}">
                        {% csrf_token %}
                        <input type="text" name="title" placeholder="Position title">
                        <input type="text" name="company" placeholder="Company">
                        <input type="date" name="start_date">
                        <input type="date" name="end_date">
                        <input type="text" name="location" placeholder="Location">
                        <div style="text-align:right;margin-top:10px;"><button type="submit"
                                class="btn primary">Save</button></div>
                    </form>
                </div>
            </div>

            <!-- Education Modal -->
            <div id="educationModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close educationClose">&times;</span>
                    <h3>Add / Edit education</h3>
                    <form method="POST" action="{% url 'save_education' %}">
                        {% csrf_token %}
                        <input type="text" name="school" placeholder="School">
                        <input type="text" name="degree" placeholder="Degree">
                        <input type="number" name="start_year" placeholder="Start year">
                        <input type="number" name="end_year" placeholder="End year">
                        <div style="text-align:right;margin-top:10px;"><button type="submit"
                                class="btn primary">Save</button></div>
                    </form>
                </div>
            </div>

            <!-- Edit Profile Modal -->
            <div id="editProfileModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close" id="editProfileClose">&times;</span>
                    <h3>Edit intro</h3>
                    <form id="editProfileForm" method="POST" action="{% url 'edit_profile' %}"
                        enctype="multipart/form-data">
                        {% csrf_token %}
                        <label>First name</label>
                        <input type="text" name="first_name" value="{{ user_profile.first_name }}">
                        <label>Last name</label>
                        <input type="text" name="last_name" value="{{ user_profile.last_name }}">
                        <label>Headline</label>
                        <input type="text" name="headline" value="{{ user_profile.profile.headline }}">
                        <label>Location</label>
                        <input type="text" name="location" value="{{ user_profile.profile.location }}">
                        <label>Education</label>
                        <input type="text" name="education">
                        <label>Profile picture</label>
                        <input type="file" name="profile_picture">
                        <label>Background image</label>
                        <input type="file" name="background_image">
                        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
                            <button type="button" class="btn ghost" id="editCancel">Cancel</button>
                            <button type="submit" class="btn primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>

        </section>

        <!-- Right Sidebar -->
        <aside class="sidebar-right">
            <div class="widget">
                <h4>LinkedIn News</h4>
                <ul>
                    <li>🚀 AI is booming in 2025</li>
                    <li>💼 Tech jobs in demand</li>
                    <li>🌍 Remote work trends</li>
                </ul>
            </div>
        </aside>
    </main>
    <script src="{% static 'js/modal.js' %}"></script>
    <script src="{% static 'js/notifications.js' %}"></script>
    <script src="{% static 'js/post_interactions.js' %}"></script>
    <script src="{% static 'js/profile_page.js'%}"></script>
</body>

</html>